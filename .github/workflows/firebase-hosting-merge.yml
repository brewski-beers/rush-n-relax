# Production deployment on merge to main
# - `verify` runs core E2E suite against emulators
# - `deploy` only runs after verify passes
name: Main â€” Verify & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: main-verify-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify:
    name: verify
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Unit tests
        run: npm run test -- --run

      - name: Setup Playwright (Chromium)
        uses: ./.github/actions/setup-playwright
        with:
          browsers: chromium

      - name: E2E tests
        run: >-
          npx firebase-tools emulators:exec --project=rush-n-relax --only=firestore,storage
          "node scripts/seed-emulators.cjs && npm run test:e2e:core -- --project=chromium"
        env:
          VITE_USE_EMULATORS: 'true'
          CI: 'true'

      - name: Upload verify failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: main-verify-failures
          path: test-results/
          if-no-files-found: ignore
          retention-days: 3

  deploy:
    name: deploy
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      FIREBASE_DEPLOY_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_RUSH_N_RELAX }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Validate deploy credentials
        run: |
          if [ -z "$FIREBASE_DEPLOY_SERVICE_ACCOUNT_JSON" ]; then
            echo "Missing deploy credentials. Set FIREBASE_SERVICE_ACCOUNT_RUSH_N_RELAX."
            exit 1
          fi

      - name: Build
        run: npm run build
        env:
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}

      - name: Write deploy credentials
        run: |
          printf '%s' "$FIREBASE_DEPLOY_SERVICE_ACCOUNT_JSON" > $HOME/gcloud-key.json

      - name: Deploy Firestore rules and indexes
        run: |
          GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json \
            npx firebase-tools deploy \
            --only firestore:rules,firestore:indexes \
            --project rush-n-relax \
            --non-interactive

      - name: Deploy Storage rules
        run: |
          set -o pipefail
          STORAGE_DEPLOY_LOG=$(mktemp)
          if ! GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json \
            npx firebase-tools deploy \
            --only storage \
            --project rush-n-relax \
            --non-interactive 2>&1 | tee "$STORAGE_DEPLOY_LOG"; then
            if grep -q "firebasestorage.defaultBucket.get" "$STORAGE_DEPLOY_LOG"; then
              echo "::error::Deploy service account is missing firebasestorage.defaultBucket.get. Grant roles/storage.admin (or custom role including this permission) to FIREBASE_SERVICE_ACCOUNT_RUSH_N_RELAX."
            fi
            exit 1
          fi

      - name: Cleanup deploy credentials
        if: always()
        run: rm -f $HOME/gcloud-key.json

      - name: Deploy to Firebase Hosting Production
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RUSH_N_RELAX }}'
          channelId: live
          projectId: rush-n-relax
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
